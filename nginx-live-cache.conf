# Art Battle V2 Live Cache Configuration
# Include this file in the main nginx.conf http block with: include /path/to/nginx-live-cache.conf;

# Rate limiting zones (add to http block)
limit_req_zone $binary_remote_addr zone=live_api:10m rate=20r/m;

# Cache zone for live endpoints (add to http block)  
proxy_cache_path /var/cache/nginx/live levels=1:2 keys_zone=live_cache:10m max_size=500m inactive=1h use_temp_path=off;

# Server block additions for artb.art
# Add these location blocks to the existing artb.art server block

# Live API endpoints with 5-second caching
location /live/ {
    # Rate limiting protection
    limit_req zone=live_api burst=10 nodelay;
    limit_req_status 429;
    
    # Route to specific Supabase functions based on path
    set $supabase_function "";
    
    if ($uri ~ ^/live/event/(.*)$) {
        set $supabase_function "v2-public-event/$1";
    }
    if ($uri = /live/events) {
        set $supabase_function "v2-public-events";
    }
    if ($uri ~ ^/live/bids/(.*)$) {
        set $supabase_function "v2-public-bids/$1";
    }
    if ($uri ~ ^/live/votes/(.*)$) {
        set $supabase_function "v2-public-votes/$1";
    }
    
    # Proxy to Supabase Edge Functions
    proxy_pass https://xsqdkubgyqwpyvfltnrf.supabase.co/functions/v1/$supabase_function;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    
    # 5-second caching
    proxy_cache live_cache;
    proxy_cache_valid 200 5s;
    proxy_cache_key "$request_uri";
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    proxy_cache_lock on;
    
    # Headers for Supabase
    proxy_set_header Host xsqdkubgyqwpyvfltnrf.supabase.co;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Response headers
    add_header X-Cache-Status $upstream_cache_status always;
    add_header Access-Control-Allow-Origin "https://artb.art" always;
    add_header Cache-Control "public, max-age=5" always;
    
    # Connection settings
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Rate limit error for live endpoints
error_page 429 /live-rate-limit.json;
location = /live-rate-limit.json {
    return 429 '{"error": "Rate limit exceeded. Max 20 requests per minute."}';
    add_header Content-Type application/json always;
    add_header Retry-After 60 always;
}