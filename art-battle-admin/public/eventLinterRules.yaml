# Event Linter Rules Configuration
# This file defines the rules for checking event health and operational readiness
# Rules are evaluated against events and generate severity-based findings

# Severity levels with emoji mappings:
# - error: ‚ùå (critical issues that block operations)
# - warning: ‚ö†Ô∏è  (issues that should be addressed)
# - info: üìä (metrics and informational items)
# - success: ‚úÖ (things that are going well)

# Rule structure:
# - id: unique identifier
# - name: human-readable name
# - description: what this rule checks
# - severity: error | warning | info | success
# - category: timing | data_completeness | operational | comparative | live_event
# - context: pre_event | during_event | post_event | always
# - conditions: array of conditions to evaluate
# - message: template for the output message (can use {{placeholders}})

rules:
  # ==================== ARTIST PAYMENT RULES ====================
  # Note: These rules check artist payment status globally, not per-event

  - id: artist_payment_overdue
    name: Artist Payment Overdue
    description: Artist hasn't been paid 14+ days after sale
    severity: error
    category: data_completeness
    context: post_event
    conditions: []  # Handled by database function
    message: "Artist payment overdue - handled by get_overdue_artist_payments()"

  # ==================== LIVE EVENT RULES ====================

  - id: live_event_photos_missing
    name: Event Started - No Photos
    description: Event has started but no photos have been uploaded
    severity: error
    category: live_event
    context: during_event
    conditions:
      - field: event_start_datetime
        operator: past_minutes
        value: 15
      - field: photos_count
        operator: equals
        value: 0
    message: "Event started {{minutes_ago}} minutes ago but no photos uploaded"

  - id: live_round_3_auction_not_closed
    name: Round 3 Ended - Auction Still Open
    description: Round 3 ended but auction has no close time
    severity: warning
    category: live_event
    context: during_event
    conditions:
      - field: rounds.3.end_time
        operator: past_minutes
        value: 10
      - field: auction_close_time
        operator: is_null
    message: "Round 3 ended {{minutes_ago}} minutes ago but auction not closed"

  - id: live_door_time_no_qr
    name: Door Time Soon - No QR Codes
    description: Door time approaching but no QR codes generated
    severity: warning
    category: live_event
    context: pre_event
    conditions:
      - field: door_time
        operator: upcoming_minutes
        value: 60
      - field: qr_codes_generated
        operator: equals
        value: 0
    message: "Door time in {{minutes_until}} minutes but no QR codes generated (testing not done?)"

  - id: live_event_no_timer_set
    name: Event Active - No Round Timer
    description: Event is active but round timer not set
    severity: error
    category: live_event
    context: during_event
    conditions:
      - field: event_start_datetime
        operator: past_minutes
        value: 5
      - field: round_timer_active
        operator: equals
        value: false
    message: "Event started {{minutes_ago}} minutes ago but round timer not activated"

  # ==================== PRE-EVENT COMPLETENESS ====================

  - id: event_tomorrow_no_venue
    name: Event Tomorrow - No Venue
    description: Event is tomorrow but venue information is missing
    severity: error
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_hours
        value: 24
      - field: venue
        operator: is_empty
    message: "Event in {{hours_until}} hours but venue not set"

  - id: event_soon_low_artists
    name: Event Soon - Low Artist Count
    description: Event in 3 days with fewer than 6 confirmed artists
    severity: warning
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 3
      - field: confirmed_artists_count
        operator: less_than
        value: 6
    message: "Event in {{days_until}} days with only {{confirmed_artists_count}} confirmed artists"

  - id: applications_open_no_city
    name: Applications Open - No City Set
    description: Applications are open but city is not configured
    severity: error
    category: data_completeness
    context: always
    conditions:
      - field: applications_open
        operator: equals
        value: true
      - field: cities.id
        operator: is_null
    message: "Applications open but city not configured"

  - id: event_week_away_no_promo
    name: Event Week Away - No Promo Materials
    description: Event is within a week but no promotional materials uploaded
    severity: warning
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: promo_materials_count
        operator: equals
        value: 0
    message: "Event in {{days_until}} days but no promo materials uploaded"

  # ==================== FUTURE EVENT CRITICAL (7 DAYS) ====================

  - id: event_week_no_artists
    name: Event Week Away - No Artists Confirmed
    description: Event in 7 days or less with no confirmed artists
    severity: error
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: confirmed_artists_count
        operator: equals
        value: 0
    message: "Event in {{days_until}} days with NO confirmed artists!"

  - id: event_week_few_artists
    name: Event Week Away - Low Artist Count
    description: Event in 7 days or less with fewer than 8 confirmed artists
    severity: warning
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: confirmed_artists_count
        operator: greater_than
        value: 0
      - field: confirmed_artists_count
        operator: less_than
        value: 8
    message: "Event in {{days_until}} days with only {{confirmed_artists_count}} confirmed artists"

  - id: event_week_no_ticket_link
    name: Event Week Away - No Ticket Link
    description: Event in 7 days or less without ticket link
    severity: error
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: ticket_link
        operator: is_empty
    message: "Event in {{days_until}} days but no ticket link configured"

  - id: event_week_no_description
    name: Event Week Away - No Description
    description: Event in 7 days or less without description
    severity: warning
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: description
        operator: is_empty
    message: "Event in {{days_until}} days but no description configured"

  # ==================== FUTURE EVENT WARNING (14 DAYS) ====================

  - id: event_2weeks_no_artists
    name: Event 2 Weeks Away - No Artists
    description: Event in 14 days or less with no confirmed artists
    severity: warning
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: event_start_datetime
        operator: upcoming_days_more_than
        value: 7
      - field: confirmed_artists_count
        operator: equals
        value: 0
    message: "Event in {{days_until}} days with no confirmed artists yet"

  - id: event_2weeks_few_artists
    name: Event 2 Weeks Away - Low Artist Count
    description: Event in 14 days or less with fewer than 4 artists
    severity: info
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: event_start_datetime
        operator: upcoming_days_more_than
        value: 7
      - field: confirmed_artists_count
        operator: greater_than
        value: 0
      - field: confirmed_artists_count
        operator: less_than
        value: 4
    message: "Event in {{days_until}} days with only {{confirmed_artists_count}} confirmed artists"

  - id: event_2weeks_no_ticket_link
    name: Event 2 Weeks Away - No Ticket Link
    description: Event in 14 days or less without ticket link
    severity: warning
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: event_start_datetime
        operator: upcoming_days_more_than
        value: 7
      - field: ticket_link
        operator: is_empty
    message: "Event in {{days_until}} days but no ticket link configured yet"

  # ==================== FUTURE EVENT SUCCESS ====================

  - id: event_well_prepared
    name: Event Well Prepared
    description: Event in next 14 days is fully configured
    severity: success
    category: data_completeness
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: confirmed_artists_count
        operator: greater_than
        value: 8
      - field: ticket_link
        operator: is_not_empty
      - field: description
        operator: is_not_empty
      - field: venue
        operator: is_not_empty
    message: "Event ready! {{confirmed_artists_count}} artists confirmed, tickets live, venue set"

  # ==================== EVENT ARTISTS ASSIGNMENTS (7 DAYS ONLY) ====================

  - id: event_artists_not_assigned_7days
    name: Event Week - Artists Not Assigned
    description: Event in 7 days or less with no artists assigned in event_artists table
    severity: error
    category: operational
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: event_artists_confirmed_count
        operator: equals
        value: 0
    message: "Event in {{days_until}} days - no artists assigned in event_artists table!"

  - id: event_artists_low_7days
    name: Event Week - Low Artist Assignments
    description: Event in 7 days or less with fewer than 8 artists assigned in event_artists table
    severity: warning
    category: operational
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: event_artists_confirmed_count
        operator: greater_than
        value: 0
      - field: event_artists_confirmed_count
        operator: less_than
        value: 8
    message: "Event in {{days_until}} days - only {{event_artists_confirmed_count}} artists assigned in event_artists table"

  # ==================== POST-EVENT COMPLETENESS ====================

  - id: event_ended_no_food_beverage
    name: Event Ended - Revenue Not Recorded
    description: Event ended 2+ days ago but food/beverage revenue not recorded
    severity: info
    category: data_completeness
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 2
      - field: food_beverage_revenue
        operator: is_null
    message: "Event ended {{days_ago}} days ago - food/beverage revenue not recorded"

  - id: event_ended_no_other_revenue
    name: Event Ended - Other Revenue Not Recorded
    description: Event ended but other revenue fields not updated
    severity: info
    category: data_completeness
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 2
      - field: other_revenue
        operator: is_null
    message: "Event ended {{days_ago}} days ago - other revenue not recorded"

  - id: event_ended_no_producer_tickets
    name: Event Ended - Producer Tickets Not Recorded
    description: Event ended but producer ticket sales not recorded
    severity: info
    category: data_completeness
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 2
      - field: producer_tickets_sold
        operator: is_null
    message: "Event ended {{days_ago}} days ago - producer ticket sales not recorded"

  # ==================== COMPARATIVE ANALYSIS ====================

  - id: ticket_sales_below_average
    name: Ticket Sales Below City Average
    description: Ticket sales are significantly below the city historical average
    severity: info
    category: comparative
    context: pre_event
    conditions:
      - field: ticket_sales
        operator: less_than_percent
        value: 70
        compare_to: city_average
    message: "Ticket sales {{percent_of_average}}% of city average ({{ticket_sales}} vs {{city_average}})"

  - id: applications_closed_low_count
    name: Applications Closed - Below Typical Count
    description: Applications closed but artist count below city typical
    severity: warning
    category: comparative
    context: pre_event
    conditions:
      - field: applications_open
        operator: equals
        value: false
      - field: applied_artists_count
        operator: less_than_percent
        value: 50
        compare_to: city_typical
    message: "Applications closed with {{applied_artists_count}} artists ({{percent_of_typical}}% of typical {{city_typical}})"

  - id: food_beverage_above_average
    name: Food/Beverage Revenue Above Average
    description: Food and beverage revenue exceeded city average
    severity: success
    category: comparative
    context: post_event
    conditions:
      - field: food_beverage_revenue
        operator: greater_than_percent
        value: 110
        compare_to: city_average
    message: "Food/beverage revenue {{percent_of_average}}% of city average! ({{food_beverage_revenue}} vs {{city_average}})"

  # ==================== OPERATIONAL TIMING ====================

  - id: event_enabled_check
    name: Event Disabled
    description: Event is disabled and won't appear in public listings
    severity: warning
    category: operational
    context: always
    conditions:
      - field: enabled
        operator: equals
        value: false
    message: "Event is disabled - not visible to public"

  - id: timezone_not_set
    name: Timezone Not Configured
    description: Event timezone not set
    severity: error
    category: operational
    context: always
    conditions:
      - field: timezone_icann
        operator: is_empty
    message: "Event timezone not configured"

  - id: slack_channel_not_set
    name: No Slack Channel
    description: Event has no Slack channel configured
    severity: info
    category: operational
    context: always
    conditions:
      - field: slack_channel
        operator: is_empty
    message: "No Slack channel configured for event communication"

  - id: eventbrite_not_linked
    name: No Eventbrite Link
    description: Event approaching but no Eventbrite integration
    severity: warning
    category: operational
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: eventbrite_id
        operator: is_empty
    message: "Event in {{days_until}} days but no Eventbrite link configured"

  # ==================== SUCCESS METRICS ====================

  - id: early_preparation_success
    name: Well Prepared Event
    description: Event is well prepared ahead of time
    severity: success
    category: operational
    context: pre_event
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 3
      - field: confirmed_artists_count
        operator: greater_than
        value: 10
      - field: venue
        operator: is_not_empty
      - field: promo_materials_count
        operator: greater_than
        value: 2
    message: "Event well prepared! {{confirmed_artists_count}} artists, venue set, {{promo_materials_count}} promo materials"

  - id: sold_out_event
    name: Event Sold Out
    description: Event has sold out
    severity: success
    category: comparative
    context: pre_event
    conditions:
      - field: sold_out
        operator: equals
        value: true
    message: "Event SOLD OUT! üéâ"

  # ==================== REVENUE COMPARATIVE ANALYSIS ====================

  - id: ticket_revenue_success
    name: Ticket Revenue Exceeded Last Event
    description: Ticket revenue exceeded the last event in this city
    severity: success
    category: comparative
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: ticket_revenue
        operator: greater_than
        value: 0
      - field: prev_ticket_revenue
        operator: is_not_null
      - field: ticket_revenue
        operator: greater_than_percent
        value: 100
        compare_to: prev_ticket_revenue
    message: "Ticket revenue ${{ticket_revenue}} exceeded last event ${{prev_ticket_revenue}} ({{prev_event_eid}})!"

  - id: ticket_revenue_decline_warning
    name: Ticket Revenue Below Last Event
    description: Ticket revenue is 20%+ lower than last event
    severity: warning
    category: comparative
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: prev_ticket_revenue
        operator: greater_than
        value: 0
      - field: ticket_revenue
        operator: less_than_percent
        value: 80
        compare_to: prev_ticket_revenue
    message: "Ticket revenue ${{ticket_revenue}} is {{percent_of_previous}}% of last event ${{prev_ticket_revenue}} ({{prev_event_eid}})"

  - id: ticket_revenue_decline_error
    name: Significant Ticket Revenue Drop
    description: Ticket revenue is 50%+ lower than last event
    severity: error
    category: comparative
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: prev_ticket_revenue
        operator: greater_than
        value: 0
      - field: ticket_revenue
        operator: less_than_percent
        value: 50
        compare_to: prev_ticket_revenue
    message: "CRITICAL: Ticket revenue ${{ticket_revenue}} is only {{percent_of_previous}}% of last event ${{prev_ticket_revenue}} ({{prev_event_eid}})"

  - id: auction_revenue_success
    name: Auction Revenue Exceeded Last Event
    description: Auction revenue exceeded the last event in this city
    severity: success
    category: comparative
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: auction_revenue
        operator: greater_than
        value: 0
      - field: prev_auction_revenue
        operator: is_not_null
      - field: auction_revenue
        operator: greater_than_percent
        value: 100
        compare_to: prev_auction_revenue
    message: "Auction revenue ${{auction_revenue}} exceeded last event ${{prev_auction_revenue}} ({{prev_event_eid}})!"

  # ==================== ENGAGEMENT COMPARATIVE ANALYSIS ====================

  - id: total_votes_success
    name: Total Votes Exceeded Last Event
    description: Total votes exceeded the last event in this city (recently ended events only)
    severity: success
    category: comparative
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: event_end_datetime
        operator: within_days
        value: 30
      - field: total_votes
        operator: greater_than
        value: 10
      - field: prev_total_votes
        operator: greater_than
        value: 10
      - field: total_votes
        operator: greater_than_percent
        value: 100
        compare_to: prev_total_votes
    message: "Total votes {{total_votes}} exceeded last event {{prev_total_votes}} ({{prev_event_eid}})! üéâ"

  - id: total_votes_decline_warning
    name: Total Votes Below Last Event
    description: Total votes are 20%+ lower than last event (recently ended events only)
    severity: warning
    category: comparative
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: event_end_datetime
        operator: within_days
        value: 30
      - field: total_votes
        operator: greater_than
        value: 0
      - field: prev_total_votes
        operator: greater_than
        value: 10
      - field: total_votes
        operator: less_than_percent
        value: 80
        compare_to: prev_total_votes
    message: "Total votes {{total_votes}} is {{percent_of_previous}}% of last event {{prev_total_votes}} ({{prev_event_eid}})"

  - id: total_votes_decline_error
    name: Significant Vote Decline
    description: Total votes are 50%+ lower than last event (recently ended events only)
    severity: error
    category: comparative
    context: post_event
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: event_end_datetime
        operator: within_days
        value: 30
      - field: total_votes
        operator: greater_than
        value: 0
      - field: prev_total_votes
        operator: greater_than
        value: 10
      - field: total_votes
        operator: less_than_percent
        value: 50
        compare_to: prev_total_votes
    message: "CRITICAL: Total votes {{total_votes}} is only {{percent_of_previous}}% of last event {{prev_total_votes}} ({{prev_event_eid}})"

# Configuration for comparative analysis
comparison_settings:
  # How far back to look for city historical data (in days)
  city_lookback_days: 365

  # Minimum number of events needed for valid city average
  min_city_events: 3

  # How to handle missing comparative data
  missing_data_behavior: skip  # options: skip | info | warning
