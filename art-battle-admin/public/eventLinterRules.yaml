# Event Linter Rules Configuration - IMPROVED VERSION
# This file defines the rules for checking event health and operational readiness
# Rules are evaluated against events and generate severity-based findings

# IMPROVEMENTS:
# 1. Consolidated duplicate rules (e.g., ticket link + Eventbrite into one rule)
# 2. Added action_url field for one-click fixes
# 3. Added priority_score for sorting by business impact
# 4. Reduced booking opportunity noise (only one rule per city, higher thresholds)
# 5. Added suppress_if conditions to prevent rule overlap

# Severity levels with emoji mappings:
# - error: ‚ùå (critical issues that block operations)
# - warning: ‚ö†Ô∏è  (issues that should be addressed)
# - info: üìä (metrics and informational items)
# - success: ‚úÖ (things that are going well)

# New fields:
# - priority_score: 1-100 (higher = more urgent/impactful)
# - action_url: Deep link to fix the issue
# - action_text: Button text for the action
# - suppress_if: Array of rule IDs that suppress this rule if they fire

rules:
  # ==================== ARTIST PAYMENT RULES ====================

  - id: artist_payment_overdue
    name: Artist Payment Overdue
    description: Artist hasn't been paid 14+ days after sale
    severity: error
    category: data_completeness
    context: post_event
    priority_score: 95
    conditions: []  # Handled by database function
    message: "Artist payment overdue - handled by get_overdue_artist_payments()"
    action_text: "Process Payment"
    action_url: "/admin/payments/artists"

  # ==================== LIVE EVENT RULES ====================

  - id: live_event_photos_missing
    name: Event Started - No Photos
    description: Event has started but no photos have been uploaded
    severity: error
    category: live_event
    context: during_event
    priority_score: 90
    conditions:
      - field: event_start_datetime
        operator: past_minutes
        value: 15
      - field: photos_count
        operator: equals
        value: 0
    message: "Event started {{minutes_ago}} minutes ago but no photos uploaded"
    action_text: "Upload Photos"
    action_url: "/admin/events/{{event_id}}/photos"

  - id: live_round_3_auction_not_closed
    name: Round 3 Ended - Auction Still Open
    description: Round 3 ended but auction has no close time
    severity: warning
    category: live_event
    context: during_event
    priority_score: 85
    conditions:
      - field: rounds.3.end_time
        operator: past_minutes
        value: 10
      - field: auction_close_time
        operator: is_null
    message: "Round 3 ended {{minutes_ago}} minutes ago but auction not closed"
    action_text: "Close Auction"
    action_url: "/admin/events/{{event_id}}/auction"

  - id: live_door_time_no_qr
    name: Door Time Soon - No QR Codes
    description: Door time approaching but no QR codes generated
    severity: warning
    category: live_event
    context: pre_event
    priority_score: 80
    conditions:
      - field: door_time
        operator: upcoming_minutes
        value: 60
      - field: qr_codes_generated
        operator: equals
        value: 0
    message: "Door time in {{minutes_until}} minutes but no QR codes generated"
    action_text: "Generate QR Codes"
    action_url: "/admin/events/{{event_id}}/qr-codes"

  - id: live_event_no_timer_set
    name: Event Active - No Round Timer
    description: Event is active but round timer not set
    severity: error
    category: live_event
    context: during_event
    priority_score: 90
    conditions:
      - field: event_start_datetime
        operator: past_minutes
        value: 5
      - field: round_timer_active
        operator: equals
        value: false
    message: "Event started {{minutes_ago}} minutes ago but round timer not activated"
    action_text: "Start Timer"
    action_url: "/admin/events/{{event_id}}/timer"

  # ==================== PRE-EVENT COMPLETENESS ====================

  - id: event_2weeks_no_venue
    name: Event 2 Weeks Away - No Venue
    description: Event in 14 days or less without venue set
    severity: warning
    category: data_completeness
    context: pre_event
    priority_score: 70
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: event_start_datetime
        operator: upcoming_days_more_than
        value: 7
      - field: venue
        operator: is_empty
    message: "Event in {{days_until}} days but venue not set"
    action_text: "Set Venue"
    action_url: "/admin/events/{{event_id}}/edit"

  - id: event_week_no_venue
    name: Event Week Away - No Venue
    description: Event in 7 days or less without venue set
    severity: error
    category: data_completeness
    context: pre_event
    priority_score: 88
    suppress_if: []
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: event_start_datetime
        operator: upcoming_days_more_than
        value: 1
      - field: venue
        operator: is_empty
    message: "Event in {{days_until}} days but venue not set"
    action_text: "Set Venue"
    action_url: "/admin/events/{{event_id}}/edit"

  - id: event_tomorrow_no_venue
    name: Event Tomorrow - No Venue
    description: Event is tomorrow but venue information is missing
    severity: error
    category: data_completeness
    context: pre_event
    priority_score: 95
    suppress_if: [event_week_no_venue]
    conditions:
      - field: event_start_datetime
        operator: upcoming_hours
        value: 24
      - field: venue
        operator: is_empty
    message: "Event in {{hours_until}} hours but venue not set"
    action_text: "Set Venue"
    action_url: "/admin/events/{{event_id}}/edit"

  - id: event_soon_low_artists
    name: Event Soon - Low Artist Count
    description: Event in 3 days with fewer than 6 confirmed artists
    severity: warning
    category: data_completeness
    context: pre_event
    priority_score: 75
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 3
      - field: confirmed_artists_count
        operator: less_than
        value: 6
    message: "Event in {{days_until}} days with only {{confirmed_artists_count}} confirmed artists"
    action_text: "Confirm Artists"
    action_url: "/admin/events/{{event_id}}/artists"

  - id: applications_open_no_city
    name: Applications Open - No City Set
    description: Applications are open but city is not configured
    severity: error
    category: data_completeness
    context: always
    priority_score: 100
    conditions:
      - field: applications_open
        operator: equals
        value: true
      - field: cities.id
        operator: is_null
    message: "Applications open but city not configured"
    action_text: "Set City"
    action_url: "/admin/events/{{event_id}}/edit"

  - id: event_week_away_no_promo
    name: Event Week Away - No Promo Materials
    description: Event is within a week but no promotional materials uploaded
    severity: warning
    category: data_completeness
    context: pre_event
    priority_score: 60
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: promo_materials_count
        operator: equals
        value: 0
    message: "Event in {{days_until}} days but no promo materials uploaded"
    action_text: "Upload Promo"
    action_url: "/admin/events/{{event_id}}/media"

  # ==================== FUTURE EVENT CRITICAL (7 DAYS) ====================

  - id: event_week_no_artists
    name: Event Week Away - No Artists Confirmed
    description: Event in 7 days or less with no confirmed artists
    severity: error
    category: data_completeness
    context: pre_event
    priority_score: 90
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: confirmed_artists_count
        operator: equals
        value: 0
    message: "Event in {{days_until}} days with NO confirmed artists!"
    action_text: "Confirm Artists"
    action_url: "/admin/events/{{event_id}}/artists"

  - id: event_week_few_artists
    name: Event Week Away - Low Artist Count
    description: Event in 7 days or less with fewer than 8 confirmed artists
    severity: warning
    category: data_completeness
    context: pre_event
    priority_score: 75
    suppress_if: [event_week_no_artists]
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: confirmed_artists_count
        operator: greater_than
        value: 0
      - field: confirmed_artists_count
        operator: less_than
        value: 8
    message: "Event in {{days_until}} days with only {{confirmed_artists_count}} confirmed artists"
    action_text: "Confirm More Artists"
    action_url: "/admin/events/{{event_id}}/artists"

  # CONSOLIDATED: Ticket link OR Eventbrite (not both)
  - id: event_week_no_tickets
    name: Event Week Away - No Ticketing Configured
    description: Event in 7 days or less without ticket link or Eventbrite
    severity: error
    category: data_completeness
    context: pre_event
    priority_score: 85
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: ticket_link
        operator: is_empty
      - field: eventbrite_id
        operator: is_empty
    message: "Event in {{days_until}} days but no ticket link configured (Eventbrite or custom link)"
    action_text: "Configure Tickets"
    action_url: "/admin/events/{{event_id}}/edit"

  - id: event_week_no_description
    name: Event Week Away - No Description
    description: Event in 7 days or less without description
    severity: warning
    category: data_completeness
    context: pre_event
    priority_score: 50
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: description
        operator: is_empty
    message: "Event in {{days_until}} days but no description configured"
    action_text: "Add Description"
    action_url: "/admin/events/{{event_id}}/edit"

  # ==================== FUTURE EVENT WARNING (14 DAYS) ====================

  - id: event_2weeks_no_artists
    name: Event 2 Weeks Away - No Artists
    description: Event in 14 days or less with no confirmed artists
    severity: warning
    category: data_completeness
    context: pre_event
    priority_score: 70
    suppress_if: [event_week_no_artists]
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: event_start_datetime
        operator: upcoming_days_more_than
        value: 7
      - field: confirmed_artists_count
        operator: equals
        value: 0
    message: "Event in {{days_until}} days with no confirmed artists yet"
    action_text: "Confirm Artists"
    action_url: "/admin/events/{{event_id}}/artists"

  - id: event_2weeks_few_artists
    name: Event 2 Weeks Away - Low Artist Count
    description: Event in 14 days or less with fewer than 4 artists
    severity: info
    category: data_completeness
    context: pre_event
    priority_score: 50
    suppress_if: [event_week_few_artists, event_2weeks_no_artists]
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: event_start_datetime
        operator: upcoming_days_more_than
        value: 7
      - field: confirmed_artists_count
        operator: greater_than
        value: 0
      - field: confirmed_artists_count
        operator: less_than
        value: 4
    message: "Event in {{days_until}} days with only {{confirmed_artists_count}} confirmed artists"
    action_text: "Confirm More Artists"
    action_url: "/admin/events/{{event_id}}/artists"

  # CONSOLIDATED: Only warn about tickets at 14 days if not already warned at 7 days
  - id: event_2weeks_no_tickets
    name: Event 2 Weeks Away - No Ticketing
    description: Event in 14 days or less without ticket link or Eventbrite
    severity: warning
    category: data_completeness
    context: pre_event
    priority_score: 65
    suppress_if: [event_week_no_tickets]
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: event_start_datetime
        operator: upcoming_days_more_than
        value: 7
      - field: ticket_link
        operator: is_empty
      - field: eventbrite_id
        operator: is_empty
    message: "Event in {{days_until}} days but no ticket link configured yet"
    action_text: "Configure Tickets"
    action_url: "/admin/events/{{event_id}}/edit"

  # ==================== PRE-EVENT APPROVAL ====================

  - id: event_basics_not_approved_14days
    name: Event Basics Not Approved
    description: Event in 14 days but basics not yet approved by producer
    severity: warning
    category: pre_event
    context: pre_event
    priority_score: 60
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: basics_approved
        operator: equals
        value: false
    message: "Event basics not yet approved by producer - {{days_until}} days to event"
    action_text: "Review & Approve"
    action_url: "/admin/events/{{event_id}}/approval"

  # ==================== OPERATIONAL REQUIREMENTS ====================

  - id: no_tax_rate_auction
    name: No Tax Rate for Auction
    description: Event auction sales will have no tax rate applied
    severity: warning
    category: operational
    context: always
    priority_score: 55
    conditions:
      - field: tax_rate_auction
        operator: is_null
    message: "No tax rate set for auction sales"
    action_text: "Set Tax Rate"
    action_url: "/admin/events/{{event_id}}/financial"

  - id: missing_eventbrite_id_historical
    name: Missing Eventbrite ID
    description: Event from past 4 years has no Eventbrite ID configured
    severity: warning
    category: data_completeness
    context: always
    priority_score: 30
    conditions:
      - field: event_start_datetime
        operator: within_days
        value: 1460
      - field: eventbrite_id
        operator: is_empty
    message: "No Eventbrite ID linked for historical tracking"
    action_text: "Add Eventbrite ID"
    action_url: "/admin/events/{{event_id}}/edit"

  - id: missing_venue_historical
    name: Missing Venue
    description: Event from past 4 years has no venue configured
    severity: warning
    category: data_completeness
    context: always
    priority_score: 50
    conditions:
      - field: event_start_datetime
        operator: within_days
        value: 1460
      - field: venue
        operator: is_empty
    message: "No venue set - needed for historical records and emails"
    action_text: "Set Venue"
    action_url: "/admin/events/{{event_id}}/edit"

  # ==================== FUTURE EVENT SUCCESS ====================

  - id: event_well_prepared
    name: Event Well Prepared
    description: Event in next 14 days is fully configured
    severity: success
    category: data_completeness
    context: pre_event
    priority_score: 0
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 14
      - field: confirmed_artists_count
        operator: greater_than
        value: 8
      - field: ticket_link
        operator: is_not_empty
      - field: description
        operator: is_not_empty
      - field: venue
        operator: is_not_empty
    message: "Event ready! {{confirmed_artists_count}} artists confirmed, tickets live, venue set"

  # ==================== EVENT ARTISTS ASSIGNMENTS (7 DAYS ONLY) ====================

  - id: event_artists_not_assigned_7days
    name: Event Week - Artists Not Assigned
    description: Event in 7 days or less with no artists assigned in event_artists table
    severity: error
    category: operational
    context: pre_event
    priority_score: 88
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: event_artists_confirmed_count
        operator: equals
        value: 0
    message: "Event in {{days_until}} days - no artists assigned in event_artists table!"
    action_text: "Assign Artists"
    action_url: "/admin/events/{{event_id}}/artists"

  - id: event_artists_low_7days
    name: Event Week - Low Artist Assignments
    description: Event in 7 days or less with fewer than 8 artists assigned in event_artists table
    severity: warning
    category: operational
    context: pre_event
    priority_score: 73
    suppress_if: [event_artists_not_assigned_7days]
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 7
      - field: event_artists_confirmed_count
        operator: greater_than
        value: 0
      - field: event_artists_confirmed_count
        operator: less_than
        value: 8
    message: "Event in {{days_until}} days - only {{event_artists_confirmed_count}} artists assigned in event_artists table"
    action_text: "Assign More Artists"
    action_url: "/admin/events/{{event_id}}/artists"

  # ==================== POST-EVENT COMPLETENESS ====================

  - id: event_ended_no_food_beverage
    name: Event Ended - Revenue Not Recorded
    description: Event ended 2+ days ago but food/beverage revenue not recorded
    severity: info
    category: data_completeness
    context: post_event
    priority_score: 40
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 2
      - field: food_beverage_revenue
        operator: is_null
    message: "Event ended {{days_ago}} days ago - food/beverage revenue not recorded"
    action_text: "Record Revenue"
    action_url: "/admin/events/{{event_id}}/financial"

  - id: event_ended_no_other_revenue
    name: Event Ended - Other Revenue Not Recorded
    description: Event ended but other revenue fields not updated
    severity: info
    category: data_completeness
    context: post_event
    priority_score: 35
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 2
      - field: other_revenue
        operator: is_null
    message: "Event ended {{days_ago}} days ago - other revenue not recorded"
    action_text: "Record Revenue"
    action_url: "/admin/events/{{event_id}}/financial"

  - id: event_ended_no_producer_tickets
    name: Event Ended - Producer Tickets Not Recorded
    description: Event ended but producer ticket sales not recorded
    severity: info
    category: data_completeness
    context: post_event
    priority_score: 38
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 2
      - field: producer_tickets_sold
        operator: is_null
    message: "Event ended {{days_ago}} days ago - producer ticket sales not recorded"
    action_text: "Record Tickets"
    action_url: "/admin/events/{{event_id}}/financial"

  # ==================== COMPARATIVE ANALYSIS ====================

  - id: ticket_sales_below_average
    name: Ticket Sales Below City Average
    description: Ticket sales are significantly below the city historical average
    severity: info
    category: comparative
    context: pre_event
    priority_score: 45
    conditions:
      - field: ticket_sales
        operator: less_than_percent
        value: 70
        compare_to: city_average
    message: "Ticket sales {{percent_of_average}}% of city average ({{ticket_sales}} vs {{city_average}})"
    action_text: "View Promo Plan"
    action_url: "/admin/events/{{event_id}}/marketing"

  - id: applications_closed_low_count
    name: Applications Closed - Below Typical Count
    description: Applications closed but artist count below city typical
    severity: warning
    category: comparative
    context: pre_event
    priority_score: 55
    conditions:
      - field: applications_open
        operator: equals
        value: false
      - field: applied_artists_count
        operator: less_than_percent
        value: 50
        compare_to: city_typical
    message: "Applications closed with {{applied_artists_count}} artists ({{percent_of_typical}}% of typical {{city_typical}})"
    action_text: "View Artists"
    action_url: "/admin/events/{{event_id}}/artists"

  - id: food_beverage_above_average
    name: Food/Beverage Revenue Above Average
    description: Food and beverage revenue exceeded city average
    severity: success
    category: comparative
    context: post_event
    priority_score: 0
    conditions:
      - field: food_beverage_revenue
        operator: greater_than_percent
        value: 110
        compare_to: city_average
    message: "Food/beverage revenue {{percent_of_average}}% of city average! ({{food_beverage_revenue}} vs {{city_average}})"

  # ==================== OPERATIONAL TIMING ====================

  - id: event_enabled_check
    name: Event Disabled
    description: Event is disabled and won't appear in public listings
    severity: warning
    category: operational
    context: always
    priority_score: 65
    conditions:
      - field: enabled
        operator: equals
        value: false
      - field: eid
        operator: not_equals
        value: "AB8888"  # Exclude the deleted events holder
    message: "Event is disabled - not visible to public"
    action_text: "Enable Event"
    action_url: "/admin/events/{{event_id}}/edit"

  - id: timezone_not_set
    name: Timezone Not Configured
    description: Event timezone not set
    severity: error
    category: operational
    context: always
    priority_score: 80
    conditions:
      - field: timezone_icann
        operator: is_empty
    message: "Event timezone not configured"
    action_text: "Set Timezone"
    action_url: "/admin/events/{{event_id}}/edit"

  - id: slack_channel_not_set
    name: No Slack Channel
    description: Event has no Slack channel configured
    severity: info
    category: operational
    context: always
    priority_score: 20
    conditions:
      - field: slack_channel
        operator: is_empty
    message: "No Slack channel configured for event communication"
    action_text: "Set Channel"
    action_url: "/admin/events/{{event_id}}/edit"

  # ==================== SUCCESS METRICS ====================

  - id: early_preparation_success
    name: Well Prepared Event
    description: Event is well prepared ahead of time
    severity: success
    category: operational
    context: pre_event
    priority_score: 0
    conditions:
      - field: event_start_datetime
        operator: upcoming_days
        value: 3
      - field: confirmed_artists_count
        operator: greater_than
        value: 10
      - field: venue
        operator: is_not_empty
      - field: promo_materials_count
        operator: greater_than
        value: 2
    message: "Event well prepared! {{confirmed_artists_count}} artists, venue set, {{promo_materials_count}} promo materials"

  - id: sold_out_event
    name: Event Sold Out
    description: Event has sold out
    severity: success
    category: comparative
    context: pre_event
    priority_score: 0
    conditions:
      - field: sold_out
        operator: equals
        value: true
    message: "Event SOLD OUT! üéâ"

  # ==================== REVENUE COMPARATIVE ANALYSIS ====================

  - id: ticket_revenue_success
    name: Ticket Revenue Exceeded Last Event
    description: Ticket revenue exceeded the last event in this venue
    severity: success
    category: comparative
    context: post_event
    priority_score: 0
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: ticket_revenue
        operator: greater_than
        value: 0
      - field: prev_ticket_revenue
        operator: is_not_null
      - field: ticket_revenue
        operator: greater_than_percent
        value: 100
        compare_to: prev_ticket_revenue
    message: "Ticket revenue ${{ticket_revenue}} exceeded last event ${{prev_ticket_revenue}} ({{prev_event_eid}})!"

  - id: ticket_revenue_decline_warning
    name: Ticket Revenue Below Last Event
    description: Ticket revenue is 20%+ lower than last event in venue
    severity: warning
    category: comparative
    context: post_event
    priority_score: 60
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: prev_ticket_revenue
        operator: greater_than
        value: 0
      - field: ticket_revenue
        operator: less_than_percent
        value: 80
        compare_to: prev_ticket_revenue
    message: "Ticket revenue ${{ticket_revenue}} is {{percent_of_previous}}% of last event ${{prev_ticket_revenue}} ({{prev_event_eid}})"
    action_text: "Analyze Event"
    action_url: "/admin/events/{{event_id}}/analysis"

  - id: ticket_revenue_decline_error
    name: Significant Ticket Revenue Drop
    description: Ticket revenue is 50%+ lower than last event in venue
    severity: error
    category: comparative
    context: post_event
    priority_score: 85
    suppress_if: [ticket_revenue_decline_warning]
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: prev_ticket_revenue
        operator: greater_than
        value: 0
      - field: ticket_revenue
        operator: less_than_percent
        value: 50
        compare_to: prev_ticket_revenue
    message: "CRITICAL: Ticket revenue ${{ticket_revenue}} is only {{percent_of_previous}}% of last event ${{prev_ticket_revenue}} ({{prev_event_eid}})"
    action_text: "Analyze Event"
    action_url: "/admin/events/{{event_id}}/analysis"

  - id: auction_revenue_success
    name: Auction Revenue Exceeded Last Event
    description: Auction revenue exceeded the last event in this venue
    severity: success
    category: comparative
    context: post_event
    priority_score: 0
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: auction_revenue
        operator: greater_than
        value: 0
      - field: prev_auction_revenue
        operator: is_not_null
      - field: auction_revenue
        operator: greater_than_percent
        value: 100
        compare_to: prev_auction_revenue
    message: "Auction revenue ${{auction_revenue}} exceeded last event ${{prev_auction_revenue}} ({{prev_event_eid}})!"

  # ==================== ENGAGEMENT COMPARATIVE ANALYSIS ====================

  - id: total_votes_success
    name: Total Votes Exceeded Last Event
    description: Total votes exceeded the last event in this venue (recently ended events only)
    severity: success
    category: comparative
    context: post_event
    priority_score: 0
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: event_end_datetime
        operator: within_days
        value: 30
      - field: total_votes
        operator: greater_than
        value: 10
      - field: prev_total_votes
        operator: greater_than
        value: 10
      - field: total_votes
        operator: greater_than_percent
        value: 100
        compare_to: prev_total_votes
    message: "Total votes {{total_votes}} exceeded last event {{prev_total_votes}} ({{prev_event_eid}})! üéâ"

  - id: total_votes_decline_warning
    name: Total Votes Below Last Event
    description: Total votes are 20%+ lower than last event in venue (recently ended events only)
    severity: warning
    category: comparative
    context: post_event
    priority_score: 55
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: event_end_datetime
        operator: within_days
        value: 30
      - field: total_votes
        operator: greater_than
        value: 0
      - field: prev_total_votes
        operator: greater_than
        value: 10
      - field: total_votes
        operator: less_than_percent
        value: 80
        compare_to: prev_total_votes
    message: "Total votes {{total_votes}} is {{percent_of_previous}}% of last event {{prev_total_votes}} ({{prev_event_eid}})"
    action_text: "Analyze Event"
    action_url: "/admin/events/{{event_id}}/analysis"

  - id: total_votes_decline_error
    name: Significant Vote Decline
    description: Total votes are 50%+ lower than last event in venue (recently ended events only)
    severity: error
    category: comparative
    context: post_event
    priority_score: 80
    suppress_if: [total_votes_decline_warning]
    conditions:
      - field: event_end_datetime
        operator: past_days
        value: 1
      - field: event_end_datetime
        operator: within_days
        value: 30
      - field: total_votes
        operator: greater_than
        value: 0
      - field: prev_total_votes
        operator: greater_than
        value: 10
      - field: total_votes
        operator: less_than_percent
        value: 50
        compare_to: prev_total_votes
    message: "CRITICAL: Total votes {{total_votes}} is only {{percent_of_previous}}% of last event {{prev_total_votes}} ({{prev_event_eid}})"
    action_text: "Analyze Event"
    action_url: "/admin/events/{{event_id}}/analysis"

  # ==================== BOOKING OPPORTUNITIES ====================
  # IMPROVED: Consolidated to one rule per city, higher thresholds, with priority scoring

  - id: booking_opportunity_strong_city
    name: Strong City Booking Opportunity
    description: City had exceptional events (300+ votes) but no future event booked
    severity: warning
    category: booking_opportunity
    context: always
    priority_score: 70
    conditions:
      - field: has_future_event
        operator: equals
        value: false
      - field: best_recent_votes
        operator: greater_than
        value: 300
    message: "{{city_name}} had strong events recently ({{best_recent_event_eid}} ({{best_recent_votes}} votes)) but no future event is booked"
    action_text: "Book Event"
    action_url: "/admin/cities/{{city_id}}/book"

# Configuration for comparative analysis
comparison_settings:
  # How far back to look for city historical data (in days)
  city_lookback_days: 365

  # Minimum number of events needed for valid city average
  min_city_events: 3

  # How to handle missing comparative data
  missing_data_behavior: skip  # options: skip | info | warning

# Configuration for booking opportunities
booking_settings:
  # Only show cities with events this strong (minimum votes)
  min_votes_threshold: 300

  # Only look back this many days for "recent" events
  recent_lookback_days: 730  # 2 years

  # Don't show "very strong historically" separately - just use one rule
  combine_historical_and_recent: true
