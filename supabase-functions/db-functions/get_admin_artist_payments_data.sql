                                                                                                                                                                                                                                                                                              pg_get_functiondef                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE OR REPLACE FUNCTION public.get_admin_artist_payments_data(cutoff_date timestamp with time zone)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
  RETURNS TABLE(artist_id uuid, artist_name text, artist_email text, artist_phone text, artist_entry_id integer, artist_country text, artist_person_id text, artist_created_at timestamp with time zone, payment_account_status text, stripe_recipient_id text, estimated_balance numeric, latest_payment_status text, payment_pending_count bigint, payment_processing_count bigint, payment_completed_count bigint, payment_failed_count bigint, payment_manual_count bigint, recent_city text, recent_contests bigint, is_recent_contestant boolean, art_sales_total numeric, payment_debits_total numeric)+
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   WITH recent_contestants AS (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     SELECT DISTINCT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
       ap.entry_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       COUNT(*) as contest_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
       COALESCE(c.name, 'Unknown') as city_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     FROM round_contestants rc                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     JOIN rounds r ON rc.round_id = r.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     JOIN events e ON r.event_id = e.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     JOIN artist_profiles ap ON rc.artist_id = ap.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     LEFT JOIN cities c ON e.city_id = c.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     WHERE e.event_start_datetime >= cutoff_date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     GROUP BY ap.entry_id, c.name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   ),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   art_sales AS (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       ap.entry_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       SUM(COALESCE(a.final_price, a.current_bid, 0) * 0.5) as sales_total                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     FROM art a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     JOIN events e ON a.event_id = e.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     JOIN artist_profiles ap ON a.artist_id = ap.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     WHERE a.status IN ('sold', 'paid', 'closed')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
       AND COALESCE(a.final_price, a.current_bid, 0) > 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     GROUP BY ap.entry_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   ),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   payment_debits AS (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       aprof.entry_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       SUM(ap.gross_amount) as debits_total                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     FROM artist_payments ap                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     JOIN artist_profiles aprof ON ap.artist_profile_id = aprof.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     WHERE ap.status IN ('completed', 'paid')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     GROUP BY aprof.entry_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   ),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   payment_history AS (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       aprof.entry_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       COUNT(*) FILTER (WHERE ap.status = 'pending') as pending_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       COUNT(*) FILTER (WHERE ap.status = 'processing') as processing_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
       COUNT(*) FILTER (WHERE ap.status = 'completed') as completed_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
       COUNT(*) FILTER (WHERE ap.status = 'failed') as failed_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
       COUNT(*) FILTER (WHERE ap.payment_type = 'manual') as manual_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
       MAX(ap.created_at) FILTER (WHERE ap.status IS NOT NULL) as latest_payment_date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     FROM artist_payments ap                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     JOIN artist_profiles aprof ON ap.artist_profile_id = aprof.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     GROUP BY aprof.entry_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   ),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   latest_payments AS (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     SELECT DISTINCT ON (aprof.entry_id)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       aprof.entry_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       ap.status as latest_status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     FROM artist_payments ap                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     JOIN artist_profiles aprof ON ap.artist_profile_id = aprof.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     ORDER BY aprof.entry_id, ap.created_at DESC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     ap.id as artist_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     ap.name as artist_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     ap.email as artist_email,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     ap.phone as artist_phone,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     ap.entry_id as artist_entry_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     ap.country as artist_country,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     ap.person_id as artist_person_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     ap.created_at as artist_created_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       WHEN agp.status = 'completed' THEN 'ready'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
       WHEN agp.status = 'pending' THEN 'invited'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
       WHEN agp.status = 'ready' THEN 'ready'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHEN agp.status = 'invited' THEN 'invited'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
       WHEN agp.status IS NOT NULL THEN 'needs_setup'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       ELSE NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     END as payment_account_status,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     agp.stripe_recipient_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     GREATEST(0, COALESCE(asales.sales_total, 0) - COALESCE(pd.debits_total, 0)) as estimated_balance,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     lp.latest_status as latest_payment_status,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     COALESCE(ph.pending_count, 0) as payment_pending_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     COALESCE(ph.processing_count, 0) as payment_processing_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     COALESCE(ph.completed_count, 0) as payment_completed_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     COALESCE(ph.failed_count, 0) as payment_failed_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     COALESCE(ph.manual_count, 0) as payment_manual_count,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     COALESCE(rc.city_name, 'Unknown') as recent_city,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     COALESCE(rc.contest_count, 0) as recent_contests,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     (rc.entry_id IS NOT NULL) as is_recent_contestant,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     COALESCE(asales.sales_total, 0) as art_sales_total,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     COALESCE(pd.debits_total, 0) as payment_debits_total                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   FROM artist_profiles ap                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   LEFT JOIN artist_global_payments agp ON ap.id = agp.artist_profile_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   LEFT JOIN recent_contestants rc ON ap.entry_id = rc.entry_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
   LEFT JOIN art_sales asales ON ap.entry_id = asales.entry_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   LEFT JOIN payment_debits pd ON ap.entry_id = pd.entry_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   LEFT JOIN payment_history ph ON ap.entry_id = ph.entry_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   LEFT JOIN latest_payments lp ON ap.entry_id = lp.entry_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   ORDER BY ap.name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 
(1 row)

