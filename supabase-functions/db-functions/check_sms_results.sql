                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  pg_get_functiondef                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE OR REPLACE FUNCTION public.check_sms_results()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 AS $function$ DECLARE v_result RECORD; v_updated INTEGER := 0; v_response_data JSONB; BEGIN FOR v_result IN SELECT mq.id as message_id, mq.metadata->>'pg_net_request_id' as request_id, r.status_code, r.content::jsonb as response_data, r.error_msg FROM message_queue mq JOIN net._http_response r ON r.id = (mq.metadata->>'pg_net_request_id')::bigint WHERE mq.status = 'pending' AND mq.metadata ? 'pg_net_request_id' AND r.created > NOW() - INTERVAL '10 minutes' LOOP IF v_result.status_code = 200 THEN UPDATE message_queue SET status = 'sent'::message_status, sent_at = NOW(), metadata = metadata || jsonb_build_object('twilio_response', v_result.response_data) WHERE id = v_result.message_id; v_updated := v_updated + 1; ELSE UPDATE message_queue SET status = CASE WHEN retry_count >= 2 THEN 'failed'::message_status ELSE 'pending'::message_status END, retry_count = retry_count + 1, send_after = NOW() + INTERVAL '5 minutes' * (retry_count + 1), error_message = COALESCE(v_result.error_msg, 'HTTP ' || v_result.status_code) WHERE id = v_result.message_id; END IF; END LOOP; IF v_updated > 0 THEN RAISE NOTICE 'Updated % SMS message(s)', v_updated; END IF; END; $function$+
 
(1 row)

